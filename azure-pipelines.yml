trigger:
- main

pool:
  vmImage: 'windows-latest'

variables:
  azureSubscription: 'ServiceConnectionName1'
  resourceGroupName: 'Akhil_Test'
  location: 'East US'
  storageAccountName: 'storageaccount1'  # Change to your desired storage account name
  storageContainerName: 'templates'
  vnetName: 'VNet1'
  vnetAddressPrefix: '10.0.0.0/16'
  subnet1Name: 'Subnet1'
  subnet1Prefix: '10.0.0.0/24'
  subnet2Name: 'Subnet2'
  subnet2Prefix: '10.0.1.0/24'

jobs:
- job: DeployVNet
  displayName: 'Deploy VNet'
  steps:
  - checkout: self

  - task: UseDotNet@2
    inputs:
      packageType: 'sdk'
      version: '3.1.x'
      installationPath: $(Agent.ToolsDirectory)/dotnet

  - task: AzureStorageAccount@0
    inputs:
      azureSubscription: $(azureSubscription)
      action: 'Create'
      resourceGroupName: $(resourceGroupName)
      storageAccountName: $(storageAccountName)
      location: $(location)
      kind: 'StorageV2'
      sku: 'Standard_LRS'

  - task: AzureFileCopy@4
    inputs:
      SourcePath: '$(Build.SourcesDirectory)'
      azureSubscription: $(azureSubscription)
      Destination: 'AzureBlob'
      storage: $(storageAccountName)
      containerName: $(storageContainerName)
      BlobPrefix: 'arm-templates/'

  - task: AzureResourceGroupDeployment@3
    inputs:
      azureSubscription: $(azureSubscription)
      action: 'Create Or Update Resource Group'
      resourceGroupName: $(resourceGroupName)
      location: $(location)
      templateLocation: 'Linked artifact'
      csmFile: 'https://storageaccount1.blob.core.windows.net/templates/VNET.json'  # Update with your storage account and file path
      overrideParameters: '-vnetName $(vnetName) -vnetAddressPrefix $(vnetAddressPrefix) -subnet1Name $(subnet1Name) -subnet1Prefix $(subnet1Prefix) -subnet2Name $(subnet2Name) -subnet2Prefix $(subnet2Prefix) -location $(location)'
